/* Command: @on_web_app_data */ 

let ADMIN_ID = 123456789; // <-- ‡ßß. ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø (‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ) ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!

try {
    let payload = JSON.parse(data); 
    
    // ‡ß®. ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ /admin_init_config ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
    let settings = Bot.getProperty('settings') || {};
    let dynamicTasks = Bot.getProperty('dynamic_tasks') || [];
    let bannedUsers = Bot.getProperty('banned_users') || [];
    let withdrawalRequests = Bot.getProperty('withdrawal_requests') || [];

    let is_admin = user.id.toString() === ADMIN_ID.toString();
    let responseData = { is_admin: is_admin };

    // --- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶ö‡ßá‡¶ï (‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶¨‡ßç‡¶≤‡¶ï) ---
    if (bannedUsers.includes(user.id) && !is_admin) {
        responseData.is_banned = true;
        responseData.error = "üö´ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶¨‡ßç‡¶≤‡¶ï‡¶°‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§";
    }

    // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç ---
    if (payload.action === 'submit_withdrawal') {
        let coinsRes = Libs.ResourcesLib.userRes('coins');
        let amount = parseInt(payload.amount);
        
        if (amount < settings.min_withdrawal) {
            responseData.error = "‚ùå ‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶ï‡¶Ø‡¶º‡ßá‡¶®‡•§";
        } else if (coinsRes.value() < amount) {
            responseData.error = "‚ùå ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶®‡ßá‡¶á‡•§";
        } else {
            // ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
            withdrawalRequests.push({ user_id: user.id, username: user.username || 'N/A', amount: amount, method: payload.method, address: payload.address, timestamp: Date.now(), status: "Pending" });
            Bot.setProperty('withdrawal_requests', withdrawalRequests, 'JSON');
            coinsRes.remove(amount); 
            responseData.success = "‚úÖ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
        }
    } 
    else if (payload.action === 'complete_task') {
        let taskId = parseInt(payload.task_id);
        let task = dynamicTasks.find(t => t.id === taskId);
        let coinsRes = Libs.ResourcesLib.userRes('coins');
        let userReferrals = Libs.ResourcesLib.userRes('referrals').value() || 0;

        if (task && !User.get('task_done_' + taskId)) {
            if (userReferrals >= task.requires_ref) {
                User.set('task_done_' + taskId, true, 'Boolean');
                coinsRes.add(task.reward);
                responseData.success = `‚úÖ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï "${task.name}" ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ü‡¶™‡¶®‡¶ø ${task.reward} ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®‡•§`;
            } else {
                 responseData.error = `‚ùå ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${task.requires_ref} ‡¶ú‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§`;
            }
        } else {
            responseData.error = "‚ùå ‡¶è‡¶á ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶ü‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶¨‡¶æ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≠‡ßÅ‡¶≤‡•§";
        }
    }
    else if (payload.action === 'process_withdrawal' && is_admin) {
        let requestIndex = payload.index;
        let action = payload.sub_action; 
        
        if (action === 'reject') {
            let rejectedCoinsRes = Libs.ResourcesLib.anotherUserRes(withdrawalRequests[requestIndex].user_id, 'coins');
            rejectedCoinsRes.add(withdrawalRequests[requestIndex].amount);
            responseData.success = `‚ùå Withdrawal ID ${withdrawalRequests[requestIndex].user_id} Rejected and refunded.`;
        } else if (action === 'approve') {
             responseData.success = `‚úÖ Withdrawal ID ${withdrawalRequests[requestIndex].user_id} Approved.`;
        }
        withdrawalRequests.splice(requestIndex, 1);
        Bot.setProperty('withdrawal_requests', withdrawalRequests, 'JSON');
    }
    else if (payload.action === 'manage_task' && is_admin) {
        let tasks = dynamicTasks;
        
        if (payload.operation === 'add') {
            let newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
            tasks.push({ id: newId, name: payload.name, reward: payload.reward, requires_ref: payload.requires_ref });
            responseData.success = "‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
        } else if (payload.operation === 'delete') {
            tasks = tasks.filter(t => t.id !== parseInt(payload.task_id));
            responseData.success = "‚úÖ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
        }
        
        Bot.setProperty('dynamic_tasks', tasks, 'JSON');
        dynamicTasks = tasks; 
    }
    else if ((payload.action === 'ban_user' || payload.action === 'unban_user') && is_admin) {
        let targetUserId = parseInt(payload.user_id);
        if (payload.action === 'ban_user' && !bannedUsers.includes(targetUserId)) {
            bannedUsers.push(targetUserId);
            responseData.success = `üö´ User ID ${targetUserId} ‡¶¨‡ßç‡¶≤‡¶ï‡¶°‡•§`;
        } else if (payload.action === 'unban_user' && bannedUsers.includes(targetUserId)) {
            bannedUsers = bannedUsers.filter(id => id !== targetUserId);
            responseData.success = `‚úÖ User ID ${targetUserId} ‡¶Ü‡¶®‡¶¨‡ßç‡¶≤‡¶ï‡¶°‡•§`;
        }
        Bot.setProperty('banned_users', bannedUsers, 'JSON');
    }
    else if (payload.action === 'update_settings' && is_admin) {
        Bot.setProperty('settings', payload.settings, 'JSON');
        responseData.success = "‚úÖ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!";
    }
    else if (payload.action === 'fetch_user_stats' && is_admin) {
        let targetUserId = parseInt(payload.user_id);
        // ... (fetch_user_stats ‡¶≤‡¶ú‡¶ø‡¶ï) ...
        // [‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶®‡ßá‡¶á, ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßá anotherUserRes ‡¶¨‡¶æ User.get ‡¶ï‡¶≤‡¶ó‡ßÅ‡¶≤‡¶ø‡¶§‡ßá]
        let targetCoinsRes = Libs.ResourcesLib.anotherUserRes(targetUserId, 'coins');
        let targetReferralsRes = Libs.ResourcesLib.anotherUserRes(targetUserId, 'referrals');
        
        let targetUserStats = { /* ... stat data ... */ };
        
        responseData.user_stats = targetUserStats;
        responseData.success = `üîç ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ID ${targetUserId} ‡¶è‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
    }


    // --- ‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶§‡ßà‡¶∞‡¶ø (‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ---
    
    let user_info = {
        id: user.id,
        coins: Libs.ResourcesLib.userRes('coins').value() || 0,
        referrals: Libs.ResourcesLib.userRes('referrals').value() || 0,
        referrer_id: User.get('referrer_id') || 'N/A'
    };

    let userTasksStatus = {};
    dynamicTasks.forEach(task => {
        userTasksStatus[task.id] = User.get('task_done_' + task.id) || false;
    });

    responseData.user_info = user_info;
    responseData.user_info.tasks_status = userTasksStatus;
    responseData.settings = settings;
    responseData.dynamic_tasks = dynamicTasks;

    if (is_admin) {
        responseData.admin_data = {
            settings: settings,
            dynamic_tasks: dynamicTasks,
            banned_users: bannedUsers,
            withdrawal_requests: withdrawalRequests
        };
    }
    
    // --- ‡ß©. ‡¶´‡¶æ‡¶á‡¶®‡¶æ‡¶≤ JSON ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü: ‡¶è‡¶ü‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶æ ‡¶â‡¶ö‡¶ø‡¶§ ---
    Bot.sendMessage(JSON.stringify(responseData), { is_json: true });

} catch (error) {
    // TBL ‡¶≤‡¶ú‡¶ø‡¶ï‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡¶≤‡ßá ‡¶è‡¶á ‡¶¨‡ßç‡¶≤‡¶ï‡¶ü‡¶ø ‡¶ö‡¶≤‡¶¨‡ßá
    Bot.sendMessage(`[FATAL TBL ERROR] Execution failed for ${user.id}: ${error}`);
    
    // error ‡¶π‡¶≤‡ßá‡¶ì ‡¶è‡¶ï‡¶ü‡¶ø valid JSON ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
    Bot.sendMessage(JSON.stringify({ error: `TBL ‡¶Ö‡¶≠‡ßç‡¶Ø‡¶®‡ßç‡¶§‡¶∞‡ßÄ‡¶£ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error}` }), { is_json: true });
}
