<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBL Mini App Admin & Task Panel</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* TBL Theme Integration and Basic Styles */
        body { 
            background: var(--tg-theme-bg-color, #ffffff); 
            color: var(--tg-theme-text-color, #000000); 
            font-family: Arial, sans-serif; 
            padding: 10px;
        }
        .container { max-width: 800px; margin: auto; }
        .panel { 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); 
        }
        .nav-button {
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .nav-button.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }
        .view { display: none; }
        .stat-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted var(--tg-theme-hint-color); }
        .stat-value { font-weight: bold; color: var(--tg-theme-button-color); }
        .withdraw-form input, .withdraw-form select {
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px;
            border: 1px solid var(--tg-theme-hint-color); background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color); box-sizing: border-box;
        }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th, .admin-table td { border: 1px solid var(--tg-theme-hint-color); padding: 8px; text-align: left; font-size: 0.85em; }
        .admin-table th { background-color: var(--tg-theme-secondary-bg-color); }
        .loading { text-align: center; padding: 20px; }
        .alert { padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .alert.success { background-color: #d4edda; color: #155724; }
        .alert.error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <div id="status-message" class="alert" style="display: none;"></div>
    <div id="loading" class="loading">‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>

    <div id="nav-bar" style="text-align: center; margin-bottom: 15px; display: none;">
        <button class="nav-button active" onclick="showView('account')">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</button>
        <button class="nav-button" onclick="showView('tasks')">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</button>
        <button class="nav-button" onclick="showView('withdraw')">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</button>
        <button class="nav-button" onclick="showView('leaderboard')">‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°</button>
        <button class="nav-button" onclick="showView('support')">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</button>
        <button class="nav-button" id="admin-nav-btn" style="display: none;" onclick="showView('admin')">‡¶è‡¶°‡¶Æ‡¶ø‡¶®</button>
    </div>

    <div id="account" class="view panel">
        <h2>üë§ ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</h2>
        <div class="stat-item"><span>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø:</span> <span id="acc-user-id" class="stat-value"></span></div>
        <div class="stat-item"><span>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ (‡¶ï‡ßü‡ßá‡¶®):</span> <span id="acc-coins" class="stat-value"></span></div>
        <div class="stat-item"><span>‡¶Æ‡ßã‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤:</span> <span id="acc-referrals" class="stat-value"></span></div>
        <div class="stat-item"><span>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï:</span> <code id="acc-ref-link" style="word-break: break-all;"></code></div>
    </div>

    <div id="tasks" class="view panel">
        <h2>üìù ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡¶∏‡¶Æ‡ßÇ‡¶π</h2>
        <p>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶™‡¶æ‡¶¨‡ßá‡¶®:</p>
        
        <div id="task-list-container">
            <p style="text-align: center;">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
        </div>
    </div>

    <div id="withdraw" class="view panel">
        <h2>üí∞ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤</h2>
        <p>‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤: <span id="min-withdraw-amount" class="stat-value"></span> ‡¶ï‡¶Ø‡¶º‡ßá‡¶®‡•§</p>
        <div class="withdraw-form">
            <input type="number" id="withdraw-amount" placeholder="‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü">
            <select id="withdraw-method">
                <option value="Bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
                <option value="Nagad">‡¶®‡¶ó‡¶¶</option>
                <option value="USDT">USDT (TRC20)</option>
            </select>
            <input type="text" id="withdraw-address" placeholder="‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂/‡¶®‡¶ó‡¶¶ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡¶æ USDT ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏">
            <button class="nav-button active" onclick="submitWithdrawal()" style="width: 100%;">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü</button>
        </div>
    </div>

    <div id="leaderboard" class="view panel">
        <h2>üìä ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶° (‡¶ü‡¶™ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤)</h2>
        <p style="color: var(--tg-theme-hint-color);">TBL ‡¶è ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶¨ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º ‡¶®‡¶æ, ‡¶§‡¶æ‡¶á ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ü‡¶™ ‡ß© ‡¶ú‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá (‡¶¨‡¶æ ‡¶ü‡¶ø‡¶¨‡¶ø‡¶è‡¶≤ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶°‡ßá‡¶ü‡¶æ):</p>
        <table class="admin-table">
            <thead><tr><th>‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶ô‡ßç‡¶ï</th><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø</th><th>‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</th></tr></thead>
            <tbody id="leaderboard-body">
                <tr><td>‡ßß</td><td>10101010</td><td>50</td></tr>
                <tr><td>‡ß®</td><td>20202020</td><td>35</td></tr>
                <tr><td>‡ß©</td><td><span id="lb-self-id"></span> (‡¶Ü‡¶™‡¶®‡¶ø)</td><td><span id="lb-self-refs"></span></td></tr>
            </tbody>
        </table>
    </div>

    <div id="support" class="view panel">
        <h2>üí° ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</h2>
        <p>‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º ‡¶¨‡¶æ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:</p>
        <a id="support-link" href="#" target="_blank" class="nav-button active" style="width: 100%; text-align: center;">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a>
    </div>

    <div id="admin" class="view panel">
        <h2>üëë ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
        
        <h3 style="color: var(--tg-theme-link-color);">üîç ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® ‡¶ì ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        <div class="withdraw-form" style="border: 1px dashed var(--tg-theme-hint-color); padding: 10px;">
            <input type="number" id="lookup-user-id" placeholder="‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 123456789)">
            <button class="nav-button active" onclick="fetchUserStats()" style="width: 100%;">‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <div id="user-stats-display" style="margin-top: 10px;"></div>
        </div>
        
        <h3 style="color: var(--tg-theme-link-color); margin-top: 20px;">üìù ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
        <p>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ:</p>
        <table class="admin-table">
            <thead><tr><th>ID</th><th>‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶®‡¶æ‡¶Æ</th><th>‡¶∞‡¶ø‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°</th><th>‡¶∞‡ßá‡¶´. ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr></thead>
            <tbody id="admin-task-list">
                </tbody>
        </table>
        
        <h4 style="margin-top: 20px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®:</h4>
        <div class="withdraw-form" style="border: 1px dashed var(--tg-theme-hint-color); padding: 10px;">
            <input type="text" id="new-task-name" placeholder="‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <input type="number" id="new-task-reward" placeholder="‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶∞‡¶ø‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶Ø‡ßá‡¶Æ‡¶®: 100)">
            <input type="number" id="new-task-ref-req" placeholder="‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 3)">
            <button class="nav-button active" onclick="manageTask('add')" style="width: 100%;">‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
        
        <h3 style="color: var(--tg-theme-link-color); margin-top: 20px;">‚öôÔ∏è ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</h3>
        <div class="withdraw-form">
            <input type="number" id="admin-ref-bonus" placeholder="‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ (‡¶ï‡¶Ø‡¶º‡ßá‡¶®)">
            <input type="number" id="admin-min-withdraw" placeholder="‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ (‡¶ï‡¶Ø‡¶º‡ßá‡¶®)">
            <input type="text" id="admin-support-link" placeholder="‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï">
            <button class="nav-button active" onclick="updateAdminSettings()" style="width: 100%;">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
        
        <h3 style="color: var(--tg-theme-link-color); margin-top: 20px;">üí∞ ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü</h3>
        <table class="admin-table">
            <thead>
                <tr><th>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</th><th>‡¶Æ‡ßá‡¶•‡¶°</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏</th><th>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</th><th>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶®</th></tr>
            </thead>
            <tbody id="admin-withdraw-requests">
                <tr><td colspan="6" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const BOT_URL = tg.initDataUnsafe.start_param ? `https://t.me/${tg.initDataUnsafe.start_param.split(' ')[0]}?start=` : '';
    let isAdmin = false;
    let globalData = {}; 

    tg.ready();
    tg.expand();
    
    // --- UI/VIEW CONTROLS ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.style.display = 'none');
        document.getElementById(viewId).style.display = 'block';
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[onclick="showView('${viewId}')"]`).classList.add('active');
    }

    // --- DATA COMMUNICATION ---
    function sendDataToBot(action, payload = {}) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('nav-bar').style.display = 'none';
        
        const requestPayload = JSON.stringify({ action: action, ...payload });
        tg.sendData(requestPayload);
    }
    
    tg.onEvent('onReceivedData', (data) => {
        document.getElementById('loading').style.display = 'none';
        
        try {
            const botData = JSON.parse(data.data);
            globalData = botData;
            
            if (botData.error) {
                showAlert(botData.error, 'error');
            } else if (botData.success) {
                showAlert(botData.success, 'success');
            }

            if(botData.is_banned) {
                 return;
            }

            renderData(botData);

        } catch (e) {
            showAlert("‡¶¨‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡•§", 'error');
            console.error("Data Parse Error:", e);
        }
    });

    // --- RENDER DATA ---
    function renderData(data) {
        document.getElementById('nav-bar').style.display = 'flex';
        
        const userInfo = data.user_info;
        const settings = data.settings;

        document.getElementById('acc-user-id').textContent = userInfo.id;
        document.getElementById('acc-coins').textContent = userInfo.coins;
        document.getElementById('acc-referrals').textContent = userInfo.referrals;
        document.getElementById('acc-ref-link').textContent = `${BOT_URL}${userInfo.id}`;
        document.getElementById('lb-self-id').textContent = userInfo.id;
        document.getElementById('lb-self-refs').textContent = userInfo.referrals;

        renderTasksView(data.dynamic_tasks, userInfo);
        
        document.getElementById('min-withdraw-amount').textContent = settings.min_withdrawal;
        document.getElementById('support-link').href = settings.support_link;

        if (data.is_admin) {
            isAdmin = true;
            document.getElementById('admin-nav-btn').style.display = 'inline';
            
            document.getElementById('admin-ref-bonus').value = settings.referral_bonus;
            document.getElementById('admin-min-withdraw').value = settings.min_withdrawal;
            document.getElementById('admin-support-link').value = settings.support_link;
            
            renderAdminTasks(data.admin_data.dynamic_tasks);
            renderWithdrawalRequests(data.admin_data.withdrawal_requests);
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('view') === 'admin' && !document.querySelector('.view:visible')) {
                showView('admin');
            } else if (!document.querySelector('.view:visible')) {
                showView('account');
            }
        } else if (!document.querySelector('.view:visible')) {
            showView('account');
        }
    }

    function renderTasksView(tasks, userInfo) {
        const container = document.getElementById('task-list-container');
        container.innerHTML = '';
        
        tasks.forEach(task => {
            const isDone = userInfo.tasks_status[task.id];
            const canComplete = userInfo.referrals >= task.requires_ref;
            
            let statusText = isDone ? '‚úÖ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®' : '‚ùå ‡¶¨‡¶æ‡¶ï‡¶ø';
            let buttonText = isDone ? '‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§' : '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            
            if (task.requires_ref > 0 && !isDone) {
                statusText += ` (${task.requires_ref} ‡¶∞‡ßá‡¶´. ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ${userInfo.referrals})`;
                buttonText = canComplete ? '‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®' : `‡¶∞‡ßá‡¶´. ‡¶ï‡¶Æ`;
            }

            container.innerHTML += `
                <div class="stat-item" style="flex-wrap: wrap;">
                    <span style="width: 100%; font-weight: bold; margin-bottom: 5px;">${task.name} (${task.reward} ‡¶ï‡¶Ø‡¶º‡ßá‡¶®)</span>
                    <span class="stat-value" style="color: ${isDone ? 'green' : 'red'};">${statusText}</span>
                    <button 
                        class="nav-button" 
                        style="margin: 0; padding: 5px 10px;"
                        onclick="submitTask(${task.id})" 
                        ${isDone || !canComplete ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                </div>
            `;
        });
    }

    // --- ADMIN SPECIFIC RENDERING ---
    function renderAdminTasks(tasks) {
        const tbody = document.getElementById('admin-task-list');
        tbody.innerHTML = '';
        
        tasks.forEach(task => {
            const row = tbody.insertRow();
            row.insertCell().textContent = task.id;
            row.insertCell().textContent = task.name;
            row.insertCell().textContent = task.reward;
            row.insertCell().textContent = task.requires_ref;
            
            const actionCell = row.insertCell();
            actionCell.innerHTML = `<button class="nav-button" style="padding: 3px 8px; background: red; color: white;" onclick="manageTask('delete', ${task.id})">‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>`;
        });
    }
    
    function renderWithdrawalRequests(requests) {
        const tbody = document.getElementById('admin-withdraw-requests');
        tbody.innerHTML = '';
        
        if (requests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</td></tr>';
            return;
        }

        requests.forEach((req, index) => {
            const row = tbody.insertRow();
            row.insertCell().textContent = req.user_id;
            row.insertCell().textContent = req.amount;
            row.insertCell().textContent = req.method;
            row.insertCell().textContent = req.address;
            row.insertCell().textContent = req.status;
            
            const actionCell = row.insertCell();
            actionCell.innerHTML = `
                <button class="nav-button" style="padding: 3px 8px; background: green; color: white; margin-right: 5px;" onclick="processWithdrawal(${index}, 'approve')">Approve</button>
                <button class="nav-button" style="padding: 3px 8px; background: red; color: white;" onclick="processWithdrawal(${index}, 'reject')">Reject</button>
            `;
        });
    }
    
    function renderUserStats(stats) {
        const isBanned = stats.is_banned;
        
        let taskListHtml = globalData.dynamic_tasks.map(task => {
            const status = stats.tasks_status[task.id] ? '‚úÖ Done' : '‚ùå Pending';
            return `<div>** ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ID ${task.id} (${task.name}):** ${status}</div>`;
        }).join('');

        document.getElementById('user-stats-display').innerHTML = `
            <div class="panel">
                <div class="stat-item"><span>‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø:</span> <span class="stat-value">${stats.id}</span></div>
                <div class="stat-item"><span>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶ï‡¶Ø‡¶º‡ßá‡¶®:</span> <span class="stat-value">${stats.coins}</span></div>
                <div class="stat-item"><span>‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤:</span> <span class="stat-value">${stats.referrals}</span></div>
                <div class="stat-item"><span>‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø:</span> <span class="stat-value">${stats.referrer_id}</span></div>
                <div class="stat-item"><span>‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</span> <span class="stat-value" style="color: ${isBanned ? 'red' : 'green'};">${isBanned ? 'üö´ BANNED' : '‚úÖ Active'}</span></div>
                <div style="margin-top: 10px;">${taskListHtml}</div>
            </div>
            <div style="text-align: center;">
                <button class="nav-button active" style="background: ${isBanned ? 'green' : 'red'};" onclick="${isBanned ? `unbanUser(${stats.id})` : `banUser(${stats.id})`}">
                    ${isBanned ? '‡¶Ü‡¶®‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®'}
                </button>
            </div>
        `;
    }

    // --- FORM SUBMISSION HANDLERS ---
    
    function submitWithdrawal() {
        const amount = parseInt(document.getElementById('withdraw-amount').value);
        const method = document.getElementById('withdraw-method').value;
        const address = document.getElementById('withdraw-address').value.trim();
        
        if (!amount || amount <= 0 || !address) {
            showAlert(`‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡ßç‡¶∞‡ßá‡¶∏ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï‡•§`, 'error');
            return;
        }
        
        sendDataToBot('submit_withdrawal', { amount: amount, method: method, address: address });
    }

    function submitTask(taskId) {
        sendDataToBot('complete_task', { task_id: taskId });
    }

    function updateAdminSettings() {
        if (!isAdmin) { return; }
        
        const newSettings = {
            referral_bonus: parseInt(document.getElementById('admin-ref-bonus').value) || 0,
            min_withdrawal: parseInt(document.getElementById('admin-min-withdraw').value) || 0,
            support_link: document.getElementById('admin-support-link').value.trim()
        };

        sendDataToBot('update_settings', { settings: newSettings });
    }
    
    function fetchUserStats() {
        const userId = parseInt(document.getElementById('lookup-user-id').value);
        if (!userId) {
            showAlert("‚ùå ‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®‡•§", 'error');
            return;
        }
        document.getElementById('user-stats-display').innerHTML = '‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
        sendDataToBot('fetch_user_stats', { user_id: userId });
    }
    
    function banUser(userId) {
        sendDataToBot('ban_user', { user_id: userId });
        setTimeout(() => sendDataToBot('fetch_user_stats', { user_id: userId }), 1000);
    }
    
    function unbanUser(userId) {
        sendDataToBot('unban_user', { user_id: userId });
        setTimeout(() => sendDataToBot('fetch_user_stats', { user_id: userId }), 1000);
    }
    
    // --- New Withdrawal Processing Handler ---
    function processWithdrawal(index, sub_action) {
        if (!isAdmin) { return; }
        if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ${sub_action === 'approve' ? 'Approve' : 'Reject'} ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`)) return;
        
        sendDataToBot('process_withdrawal', { index: index, sub_action: sub_action });
    }

    function manageTask(operation, taskId = null) {
        let payload = { operation: operation };
        
        if (operation === 'add') {
            payload.name = document.getElementById('new-task-name').value.trim();
            payload.reward = parseInt(document.getElementById('new-task-reward').value) || 0;
            payload.requires_ref = parseInt(document.getElementById('new-task-ref-req').value) || 0;
            
            if (!payload.name || payload.reward <= 0) {
                showAlert("‚ùå ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®‡•§", 'error');
                return;
            }
        } else if (operation === 'delete') {
            if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ID ${taskId} ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`)) return;
            payload.task_id = taskId;
        }
        
        sendDataToBot('manage_task', payload);
    }
    
    // --- UTILITIES ---
    function showAlert(message, type) {
        const statusDiv = document.getElementById('status-message');
        statusDiv.textContent = message;
        statusDiv.className = `alert ${type}`;
        statusDiv.style.display = 'block';
        setTimeout(() => statusDiv.style.display = 'none', 5000);
    }

    // Initial Data Fetch
    sendDataToBot('fetch_data');
</script>

</body>
</html>
